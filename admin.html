
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Extension Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --input:#1f2937;
    }
    *{box-sizing:border-box}
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #0b1220, #111827);
      color: var(--text);
      margin: 0; min-height: 100vh;
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card {
      width: 100%; max-width: 820px;
      background: rgba(17,24,39,0.9);
      border: 1px solid #1f2937;
      border-radius: 16px; padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    h1{margin:0 0 16px; font-size: 22px;}
    p.muted{color:var(--muted); margin-top:0}
    .grid {display:grid; grid-template-columns: 1fr 1fr; gap: 16px;}
    .field {display:flex; flex-direction:column; gap:6px;}
    label{font-size:13px; color:#cbd5e1}
    input {
      background: var(--input); border:1px solid #374151; color:var(--text);
      padding:10px 12px; border-radius:10px; outline:none; font-size:14px;
    }
    input::placeholder{color:#9ca3af}
    button {
      border:0; background:var(--accent); color:#052e13;
      padding:12px 14px; font-weight:700; border-radius:10px; cursor:pointer;
      transition:transform .05s ease, filter .2s ease;
    }
    button:hover{ filter:brightness(1.05) }
    button:active{ transform: translateY(1px) }
    .danger{ background: var(--danger); color:#fff; }
    .row{ display:flex; gap:12px; align-items:end; }
    .row > * { flex:1 }
    .status{ margin-top:14px; font-size:14px; }
    .ok{ color:#86efac } .err{ color:#fca5a5 }
    .section{ border-top:1px solid #1f2937; margin-top:18px; padding-top:18px;}
    .kbd{background:#0b1220;border:1px solid #1f2937;border-bottom-color:#0b1220;padding:2px 6px;border-radius:6px;color:#cbd5e1;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:12px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Extension Admin</h1>
    <p class="muted">Weekly access (expires Thu 23:59 SLT), max 4 devices / user. Use the <span class="kbd">ADMIN_KEY</span> you set on the server.</p>

    <div class="grid">
      <div class="section">
        <h3>Create User (valid until next Thu 23:59 SLT)</h3>
        <div class="field">
          <label>Admin Key</label>
          <input type="password" id="adminKey_register" placeholder="Enter ADMIN_KEY from server env">
        </div>
        <div class="field">
          <label>Username</label>
          <input id="username_register" placeholder="e.g. user123">
        </div>
        <div class="field">
          <label>Password</label>
          <input id="password_register" type="password" placeholder="••••••••">
        </div>
        <button onclick="registerUser()">Create User</button>
        <div id="status_register" class="status"></div>
      </div>

      <div class="section">
        <h3>Renew User (extend to next Thu 23:59 SLT)</h3>
        <div class="field">
          <label>Admin Key</label>
          <input type="password" id="adminKey_renew" placeholder="Enter ADMIN_KEY from server env">
        </div>
        <div class="field">
          <label>Username</label>
          <input id="username_renew" placeholder="Existing username">
        </div>
        <button class="danger" onclick="renewUser()">Renew Subscription</button>
        <div id="status_renew" class="status"></div>
      </div>
    </div>

    <div class="section">
      <h3>Check User</h3>
      <div class="row">
        <div class="field">
          <label>Admin Key</label>
          <input type="password" id="adminKey_check" placeholder="Enter ADMIN_KEY from server env">
        </div>
        <div class="field">
          <label>Username</label>
          <input id="username_check" placeholder="Existing username">
        </div>
        <button onclick="checkUser()">Check</button>
      </div>
      <div id="status_check" class="status"></div>
    </div>

    <div class="section">
      <h3>Manage Devices</h3>
      <div class="row">
        <div class="field">
          <label>Admin Key</label>
          <input type="password" id="adminKey_devices" placeholder="Enter ADMIN_KEY from server env">
        </div>
        <div class="field">
          <label>Username</label>
          <input id="username_devices" placeholder="Existing username">
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button onclick="listDevices()">List Devices</button>
        <button class="danger" onclick="resetDevices()">Reset Devices</button>
      </div>
      <div id="status_devices" class="status"></div>
    </div>
  </div>

  <script>
    async function registerUser() {
      const adminKey = document.getElementById("adminKey_register").value.trim();
      const username = document.getElementById("username_register").value.trim();
      const password = document.getElementById("password_register").value;
      const out = document.getElementById("status_register");
      out.textContent = "Working...";

      try {
        const res = await fetch("/api/admin/register", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-admin-key": adminKey },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.success) {
          out.innerHTML = `<span class="ok">✅ User created.</span> Expires: ${data.subscription_until}`;
        } else {
          out.innerHTML = `<span class="err">❌ ${data.message || "Failed"}</span>`;
        }
      } catch (e) {
        out.innerHTML = `<span class="err">❌ Network error</span>`;
      }
    }

    async function renewUser() {
      const adminKey = document.getElementById("adminKey_renew").value.trim();
      const username = document.getElementById("username_renew").value.trim();
      const out = document.getElementById("status_renew");
      out.textContent = "Working...";

      try {
        const res = await fetch("/api/admin/renew", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-admin-key": adminKey },
          body: JSON.stringify({ username })
        });
        const data = await res.json();
        if (data.success) {
          out.innerHTML = `<span class="ok">✅ Renewed.</span> New expiry: ${data.subscription_until}`;
        } else {
          out.innerHTML = `<span class="err">❌ ${data.message || "Failed"}</span>`;
        }
      } catch (e) {
        out.innerHTML = `<span class="err">❌ Network error</span>`;
      }
    }

    async function checkUser() {
      const adminKey = document.getElementById("adminKey_check").value.trim();
      const username = document.getElementById("username_check").value.trim();
      const out = document.getElementById("status_check");
      out.textContent = "Working...";

      try {
        const res = await fetch("/api/admin/check", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-admin-key": adminKey },
          body: JSON.stringify({ username })
        });
        const data = await res.json();
        if (data.success) {
          const u = data.user;
          out.innerHTML = `<span class="ok">✅ Found.</span> Active: ${u.subscription_active}, Until: ${u.subscription_until || "N/A"}`;
        } else {
          out.innerHTML = `<span class="err">❌ ${data.message || "Not found"}</span>`;
        }
      } catch (e) {
        out.innerHTML = `<span class="err">❌ Network error</span>`;
      }
    }

    async function listDevices() {
      const adminKey = document.getElementById("adminKey_devices").value.trim();
      const username = document.getElementById("username_devices").value.trim();
      const out = document.getElementById("status_devices");
      out.textContent = "Working...";

      try {
        const res = await fetch("/api/admin/devices", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-admin-key": adminKey },
          body: JSON.stringify({ username })
        });
        const data = await res.json();
        if (data.success) {
          if (!data.devices || data.devices.length === 0) {
            out.innerHTML = `<span class="err">❌ No devices found.</span>`;
          } else {
            out.innerHTML = `<span class="ok">✅ Devices:</span><br>` +
              data.devices.map(d => `ID: ${d.id}, Device: ${d.device_id}, Created: ${d.created_at}`).join("<br>");
          }
        } else {
          out.innerHTML = `<span class="err">❌ ${data.message || "Failed"}</span>`;
        }
      } catch (e) {
        out.innerHTML = `<span class="err">❌ Network error</span>`;
      }
    }

    async function resetDevices() {
      const adminKey = document.getElementById("adminKey_devices").value.trim();
      const username = document.getElementById("username_devices").value.trim();
      const out = document.getElementById("status_devices");
      out.textContent = "Working...";

      try {
        const res = await fetch("/api/admin/reset-devices", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-admin-key": adminKey },
          body: JSON.stringify({ username })
        });
        const data = await res.json();
        if (data.success) {
          out.innerHTML = `<span class="ok">✅ ${data.message}</span>`;
        } else {
          out.innerHTML = `<span class="err">❌ ${data.message || "Failed"}</span>`;
        }
      } catch (e) {
        out.innerHTML = `<span class="err">❌ Network error</span>`;
      }
    }
  </script>
</body>
</html>
